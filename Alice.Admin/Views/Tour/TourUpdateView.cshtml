
@model Alice.Service.Model.TourDTO
@{
    ViewData["Title"] = "Tur Detayı";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var categoryList = ((Alice.Admin.Models.TourCategoryViewModel)ViewBag.Categories);

}

<script src="https://cdn.ckeditor.com/ckeditor5/16.0.0/classic/ckeditor.js"></script>

<input type="hidden" value="@Model.Id" id="TourId" />

<div class="kt-container  kt-container--fluid  kt-grid__item kt-grid__item--fluid">
    <div class="kt-portlet kt-portlet--tabs">
        <div class="kt-portlet__head">
            <div class="kt-portlet__head-toolbar">
                <ul class="nav nav-tabs nav-tabs-line nav-tabs-line-success" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-toggle="tab" href="#kt_portlet_base_demo_1_1_tab_content" role="tab" aria-selected="true">
                            <i class="la la-cog"></i> Genel Tur Bilgileri
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#kt_portlet_base_demo_1_2_tab_content" role="tab" aria-selected="false">
                            <i class="la la-briefcase"></i> İşaretlemeler
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#kt_portlet_base_demo_1_3_tab_content" role="tab" aria-selected="false">
                            <i class="la la-bell-o"></i>Galeri
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#kt_portlet_base_demo_1_4_tab_content" role="tab" aria-selected="false">
                            <i class="la la-bell-o"></i>Tur Planı
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#kt_portlet_base_demo_1_5_tab_content" role="tab" aria-selected="false">
                            <i class="la la-bell-o"></i>Otel Listesi
                        </a>
                    </li>

                </ul>
            </div>
        </div>
        <div class="kt-portlet__body">
            <div class="tab-content">
                <div class="tab-pane active" id="kt_portlet_base_demo_1_1_tab_content" role="tabpanel">

                    <div class="form-group row">
                        <label for="example-text-input" class="col-2 col-form-label">Tur Adı</label>
                        <div class="col-10">
                            <input class="form-control" type="text" value="@Model.TourName" id="TourName">
                        </div>
                    </div>

                    <div class="form-group row">
                        <label for="example-text-input" class="col-2 col-form-label">Tur Kısa Açıklama</label>
                        <div class="col-10">
                            <div id="TourSpot"></div>
                        </div>
                    </div>

                    <div class="form-group row">
                        <label for="example-text-input" class="col-2 col-form-label">Tur Açıklama</label>
                        <div class="col-10">
                            <div id="TourBody"></div>
                        </div>
                    </div>

                    <div class="form-group row">
                        <label for="example-text-input" class="col-2 col-form-label"> </label>
                        <div class="col-10">
                            <button class="btn btn-outline-primary btn-sm kt-margin-t-5 kt-margin-b-5" id="TourInformationSave">Güncelle</button>
                            @*<button class="btn btn-outline-danger btn-sm kt-margin-t-5 kt-margin-b-5" id="TourCategoriesSave">Bu Turu Sil</button>*@
                        </div>
                    </div>

                </div>
                <div class="tab-pane" id="kt_portlet_base_demo_1_2_tab_content" role="tabpanel">
                    <div class="kt-checkbox-list">

                        @foreach (var item in categoryList.AllCategories.Where(x => x.MainCategoryId == 0))
                        {
                            var isChecked = categoryList.SelectAllCategories.Count(x => x.CategoriesId == item.Id);

                            <label class="kt-checkbox">
                                <input type="checkbox" @(isChecked == 1 ? "checked='checked'" : "") value="@item.Id" name="TourCategories"> <strong>@item.CategoryName</strong>
                                <span></span>
                            </label>
                            @foreach (var subItem in categoryList.AllCategories.Where(x => x.MainCategoryId == item.Id))
                            {
                                var isSubChecked = categoryList.SelectAllCategories.Count(x => x.CategoriesId == subItem.Id);
                                <label class="kt-checkbox" style="margin-left: 30px;">
                                    <input type="checkbox" @(isSubChecked == 1 ? "checked='checked'" : "") value="@subItem.Id" name="TourCategories"> @subItem.CategoryName
                                    <span></span>
                                </label>
                                @foreach (var bsubItem in categoryList.AllCategories.Where(x => x.MainCategoryId == subItem.Id))
                                {
                                    var isBSubChecked = categoryList.SelectAllCategories.Count(x => x.CategoriesId == bsubItem.Id);
                                    <label class="kt-checkbox" style="margin-left: 60px;">
                                        <input type="checkbox" @(isBSubChecked == 1 ? "checked='checked'" : "") value="@bsubItem.Id" name="TourCategories"> @bsubItem.CategoryName
                                        <span></span>
                                    </label>
                                }
                            }
                        }
                    </div>

                    <div class="form-group row">
                        <div class="col-12">
                            <br /><br />
                            <button class="btn btn-outline-primary btn-sm kt-margin-t-5 kt-margin-b-5" id="TourCategoriesSave">Güncelle</button>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="kt_portlet_base_demo_1_3_tab_content" role="tabpanel">
                    <div class="row">
                        <div class="col-xl-12">
                            <div class="col-xl-12 alreadyimagelist">

                            </div>
                            <br />
                            <div class="col-xl-12">
                                <div class="form-group">
                                    <label><strong>Aramak İstediğiniz Resim için Anahtar Kelime Seçin</strong></label>
                                    <div class="input-group">
                                        <select name="ImageSearch" class="form-control selectpicker col-10" style="border:1px solid #5578eb;">
                                            @foreach (var item in ((Alice.Admin.Models.TourCategoryViewModel)ViewBag.Categories).SelectAllKeyword)
                                            {
                                                <option value="@item.Keyword">@item.Keyword</option>
                                            }
                                        </select>
                                        <div class="input-group-append">
                                            <button class="btn btn-info resimara" type="button">Galeride Ara</button>
                                        </div>
                                    </div>
                                </div>



                                <div class="form-group galeriload">

                                </div> 

                                <div class="form-group">
                                    <div class="custom-file">
                                        <button type="submit" class="btn btn-primary resimekletamamla">Ekle</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="kt_portlet_base_demo_1_4_tab_content" role="tabpanel">
                    <div class="row dayschecked" style="display:none;">
                        <div class="col-xl-12">
                            <div class="kt-portlet__body">
                                <div class="kt-scroll ps ps--active-y" data-scroll="true" data-mobile-height="764" style="height: 945px; overflow: hidden;">
                                    <div class="kt-timeline">
                                        <div class="kt-timeline__item kt-timeline__item--accent">
                                            <div class="kt-timeline__item-section">
                                                <div class="kt-timeline__item-section-border">
                                                    <div class="kt-timeline__item-section-icon">
                                                        1
                                                    </div>
                                                </div>
                                                <span class="kt-timeline__item-datetime">01:20 AM</span>
                                            </div>
                                            <a href="#" class="kt-timeline__item-text">
                                                New secyrity alert by Firewall &amp; order to take<br> aktion on User references
                                            </a>
                                            <div class="kt-timeline__item-info">
                                                Security, Fieewall
                                            </div>
                                        </div>
                                    </div>
                                    <div class="ps__rail-x" style="left: 0px; bottom: 0px;"><div class="ps__thumb-x" tabindex="0" style="left: 0px; width: 0px;"></div></div><div class="ps__rail-y" style="top: 0px; height: 946px; right: 0px;"><div class="ps__thumb-y" tabindex="0" style="top: 0px; height: 300px;"></div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts{
    <script src="~/Content/js/pages/components/extended/sweetalert2.js" type="text/javascript"></script>
    <script>

        $(function () {

            $(".alreadyimagelist").load("/Tour/GetTourImages?Id=" + $("#TourId").val());


            $('.resimekletamamla').click(function () {
                var galleryId = $("input[name='GetGalleryByText']").val();
                var tourId = $("#TourId").val();
                $.ajax({
                type: "POST",
                url: "/Tour/AddTourGalleries",
                data: {
                    "tourId": parseInt(tourId),
                    "galleryId" : galleryId
                },
                success: function (x) {
                    if (x == false) {
                        alert("Bir Sorun Var! Lütfen tekrar deneyiniz.");
                    }
                    else {
                        swal.fire({
                            title: "Resim Ekleniyor",
                            text: "Bu aralar çok hızlıyım, merak etme hemen ekliyorum :)",
                            timer: 5000,
                            onOpen: function () {
                                swal.showLoading()
                            }
                        }).then(function (result) {
                            if (result.dismiss === 'timer') {
                                 $(".alreadyimagelist").load("/Tour/GetTourImages?Id=" + tourId);
                                //window.location.reload(false);
                            }
                        });
                    }
                },
                dataType: "json"
            });

            });

            $('.imageselect').click(function () {
                var galleryId = $(this).children("img").data("id");
            });

            $('.resimara').click(function () {
                var text = $("select[name='ImageSearch']").val();
                $(".galeriload").load("/Tour/GetGallerybyText?text=" + text);
                $('.imageselect').bind("click");
            });
        });

        let TourSpot;
        let TourBody;

        ClassicEditor
            .create(document.querySelector('#TourSpot'))
            .then(newEditor => {
                newEditor.setData("@Html.Raw(Model.TourSpot)");
                TourSpot = newEditor;
            })
            .catch(error => {
                console.error(error);
            });



        ClassicEditor
            .create(document.querySelector('#TourBody'))
            .then(newEditor => {
                newEditor.setData("@Html.Raw(Model.OverView)");
                TourBody = newEditor;
            })
            .catch(error => {
                console.error(error);
            });


        $('.imagechoose').click(function () {
            $("select[name='imagezone']").val($(this).data("number"));
        });


        // Assuming there is a <button id="submit">Submit</button> in your application.
        document.querySelector('#TourInformationSave').addEventListener('click', () => {


            $.ajax({
                type: "POST",
                url: "/Tour/UpdateTour",
                data: {
                    "Id": parseInt($("#TourId").val()),
                    "TourName": $("#TourName").val(),
                    "TourSpot": TourSpot.getData(),
                    "TourBody": TourBody.getData()
                },
                success: function (x) {
                    if (x == false) {
                        alert("Bir Sorun Var! Lütfen tekrar deneyiniz.");
                    }
                    else {
                        swal.fire({
                            title: "Genel Tur Bilgileri Güncelleniyor...",
                            text: "Sandığın gibi değil, çok hızlı güncelliyorum :)",
                            timer: 3000,
                            onOpen: function () {
                                swal.showLoading()
                            }
                        }).then(function (result) {
                            if (result.dismiss === 'timer') {
                                window.location.reload(false);
                            }
                        });
                    }
                },
                dataType: "json"
            });
        });


         document.querySelector('#TourCategoriesSave').addEventListener('click', () => {
             var ids = [];
$('input[name="TourCategories"]:checked').each(function(i, e) {
    ids.push($(this).val());
});

            $.ajax({
                type: "POST",
                url: "/Tour/UpdateCategories",
                data: {
                    "Id": parseInt($("#TourId").val()),
                    "CategoryList": ids
                },
                success: function (x) {
                    if (x == false) {
                        alert("Bir Sorun Var! Lütfen tekrar deneyiniz.");
                    }
                    else {
                        swal.fire({
                            title: "Genel Tur Bilgileri Güncelleniyor...",
                            text: "Sandığın gibi değil, çok hızlı güncelliyorum :)",
                            timer: 3000,
                            onOpen: function () {
                                swal.showLoading()
                            }
                        }).then(function (result) {
                            if (result.dismiss === 'timer') {
                                window.location.reload(false);
                            }
                        });
                    }
                },
                dataType: "json"
            });
        });

    </script>

}